<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>Cook Today</title>
  <style>
    body{font-family:system-ui;margin:16px}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:12px 0}
    button{padding:10px 12px;border-radius:10px;border:1px solid #ccc;background:#fff}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    select,input{padding:10px;border-radius:10px;border:1px solid #ccc}
    .muted{opacity:.75}
    pre{white-space:pre-wrap}
  </style>
</head>
<body>
  <h2>üç≥ Cook Today</h2>
  <div class="muted" id="status">Loading‚Ä¶</div>

  <div class="card">
    <div class="row">
      <button id="btnDaily">üçΩÔ∏è –°—Ç—Ä–∞–≤–∞ –¥–Ω—è</button>
      <button id="btnIng">üßæ –Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏</button>
      <button id="btnSteps">üë®‚Äçüç≥ –†–µ—Ü–µ–ø—Ç</button>
      <button id="btnTime">‚è± –ß–∞—Å</button>
    </div>
    <div id="dish" class="card" style="display:none"></div>
    <div id="out" class="card" style="display:none"></div>
  </div>

  <div class="card">
    <div class="row">
      <label>üåè Lang:
        <select id="lang">
          <option value="uk">uk</option>
          <option value="hr">hr</option>
          <option value="en">en</option>
        </select>
      </label>

      <label>Diet:
        <select id="diet">
          <option value="any">any</option>
          <option value="vegetarian">vegetarian</option>
          <option value="vegan">vegan</option>
          <option value="pescatarian">pescatarian</option>
        </select>
      </label>

      <label>Max time:
        <select id="max_time">
          <option value="0">‚àû</option>
          <option value="15">15</option>
          <option value="30">30</option>
          <option value="45">45</option>
          <option value="60">60</option>
        </select>
      </label>
    </div>

    <div class="row" style="margin-top:8px">
      <label><input type="checkbox" id="gluten_free"> gluten_free</label>
      <label><input type="checkbox" id="lactose_free"> lactose_free</label>
      <label><input type="checkbox" id="high_protein"> high_protein</label>
      <label><input type="checkbox" id="low_calorie"> low_calorie</label>
    </div>

    <div style="margin-top:10px">
      <div class="muted">Exclude (comma):</div>
      <input id="exclude" placeholder="onion, garlic ..." style="width:100%" />
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnSave">üíæ Save</button>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  tg?.ready(); tg?.expand();

  async function api(path, method="GET", body=null) {
    const initData = tg?.initData || "";
    const res = await fetch(path, {
      method,
      headers: {"Content-Type":"application/json","X-Telegram-Init-Data": initData},
      body: body ? JSON.stringify(body) : null
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  function show(id, yes=true){ document.getElementById(id).style.display = yes ? "block":"none"; }
  function setStatus(s){ document.getElementById("status").textContent = s; }

  function renderDish(d) {
    if (!d) { show("dish",false); return; }
    document.getElementById("dish").innerHTML = `
      <b>${d.title}</b><br/>
      <span class="muted">üè∑ ${(d.tags||[]).join(", ")} ‚Ä¢ ‚è± ~${d.time_total_min} min</span>
      <div style="margin-top:8px"><i>${d.why||""}</i></div>`;
    show("dish",true);
  }

  function renderOut(title, data) {
    if (!data) { show("out",false); return; }
    document.getElementById("out").innerHTML = `<b>${title}</b><pre>${
      Array.isArray(data) ? data.join("\n") : String(data)
    }</pre>`;
    show("out",true);
  }

  async function refreshStatus() {
    const s = await api("/api/status");
    setStatus(s.trial ? `üéÅ Trial: ${s.trial_days_left} days` : `ü™ô Tokens: ${s.tokens}`);
    document.getElementById("lang").value = s.lang || "uk";
    const f = s.filters || {};
    document.getElementById("diet").value = f.diet ?? "any";
    document.getElementById("max_time").value = String(f.max_time ?? 0);
    ["gluten_free","lactose_free","high_protein","low_calorie"].forEach(k=>{
      document.getElementById(k).checked = !!f[k];
    });
    document.getElementById("exclude").value = (f.exclude||[]).join(", ");
  }

  document.getElementById("btnDaily").onclick = async () => {
    const r = await api("/api/daily","POST");
    renderDish(r.dish);
    renderOut("", null);
    await refreshStatus();
  };
  document.getElementById("btnIng").onclick = async () => {
    const r = await api("/api/action","POST",{action:"ingredients"});
    renderOut("üßæ Ingredients", r.data);
    await refreshStatus();
  };
  document.getElementById("btnSteps").onclick = async () => {
    const r = await api("/api/action","POST",{action:"steps"});
    renderOut("üë®‚Äçüç≥ Steps", r.data);
    await refreshStatus();
  };
  document.getElementById("btnTime").onclick = async () => {
    const r = await api("/api/action","POST",{action:"time"});
    renderOut("‚è± Time", (r.data ?? 0) + " min");
    await refreshStatus();
  };

  document.getElementById("lang").onchange = async () => {
    await api("/api/lang","POST",{lang: document.getElementById("lang").value});
    await refreshStatus();
  };

  document.getElementById("btnSave").onclick = async () => {
    const payload = {
      diet: document.getElementById("diet").value,
      max_time: parseInt(document.getElementById("max_time").value, 10),
      gluten_free: document.getElementById("gluten_free").checked,
      lactose_free: document.getElementById("lactose_free").checked,
      high_protein: document.getElementById("high_protein").checked,
      low_calorie: document.getElementById("low_calorie").checked,
      exclude: document.getElementById("exclude").value.split(",").map(s=>s.trim()).filter(Boolean)
    };
    await api("/api/filters","POST",payload);
    alert("Saved ‚úÖ");
    await refreshStatus();
  };

  refreshStatus().catch(e => alert("Open inside Telegram.\n" + e.message));
</script>
</body>
</html>
